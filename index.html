<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stock Check Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-8">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center space-x-3">
                <h1 class="text-3xl font-bold text-gray-800">Live Inventory Check</h1>
                <span id="demoModeBadge" class="hidden px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300 shadow-sm">
                    ‚ö†Ô∏è DEMO DATA LOADED
                </span>
            </div>
            <button
                onclick="document.getElementById('helpModal').classList.remove('hidden')"
                class="px-4 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition duration-150 text-sm"
            >
                How to Use
            </button>
        </div>
        <p class="text-gray-500 mb-6">Scan items below to match against expected stock list. **All highlights are permanent.**</p>

        <div class="mb-8 p-4 bg-gray-50 border-2 border-gray-200 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">
                Load New Stock List
            </h2>

            <div class="mb-4 p-4 border border-gray-300 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Review Auto-Detected Headers (Modify if needed)</h3>
                <p class="text-xs text-gray-500 mb-3">
                    Paste your data first, and the system will attempt to automatically fill these fields. **Ensure they are correct** before clicking 'Load Data'.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label for="uniqueIdHeaderNameInput" class="block text-xs font-medium text-gray-700">Unique Product/SKU Header (Required)</label>
                        <input type="text" id="uniqueIdHeaderNameInput" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., SKU, Barcode, Model, IMEI">
                    </div>
                    <div>
                        <label for="quantityHeaderNameInput" class="block text-xs font-medium text-gray-700">Expected Quantity Header (Optional)</label>
                        <input type="text" id="quantityHeaderNameInput" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Qty, Count. Leave blank for single-item asset tracking.">
                    </div>
                    <div>
                        <label for="priceHeaderNameInput" class="block text-xs font-medium text-gray-700">Unit Price/Cost Header (Optional)</label>
                        <input type="text" id="priceHeaderNameInput" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Price, Cost, Retail">
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Paste Data</h3>
            <p class="text-sm text-gray-500 mb-3">
                Paste your full spreadsheet data, **including the header row**, into the box below.
            </p>
            <textarea
                id="stockDataTextarea"
                rows="5"
                class="w-full p-3 text-sm font-mono border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                placeholder="Paste your spreadsheet data here..."
            ></textarea>
            
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3 mt-3">
                <button
                    id="loadDataButton"
                    class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150"
                >
                    Load Data & Clear Scans
                </button>
                <button
                    id="resetAppButton"
                    class="w-full md:w-auto px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition duration-150"
                >
                    <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0A8.003 8.003 0 0120 13c0-3.313-2.403-6.04-5.557-6.557M4 12a8 8 0 0115.418-3m-15.356 2A8 8 0 0119.418 15m0 0H15"></path></svg>
                    Full Reset
                </button>
            </div>
            <div id="loadStatusMessage" class="mt-3 text-sm font-medium h-5"></div>
        </div>

        <div class="mb-8 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl shadow-lg">
            
            <div class="mb-4 p-3 bg-white border border-indigo-300 rounded-lg shadow-inner">
                <p class="text-xs font-semibold uppercase text-indigo-600">Last Scanned Item ID (Success)</p>
                <p id="lastScannedDisplay" class="text-2xl font-bold font-mono text-indigo-800 break-words">N/A</p>
            </div>

            <label for="scannerInput" class="block text-lg font-semibold text-indigo-800 mb-2">
                Scan Unique Identifier Here:
            </label>
            <input
                type="text"
                id="scannerInput"
                class="w-full px-4 py-3 text-xl font-mono border-4 border-indigo-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150"
                placeholder="Type or scan the unique identifier and hit Enter..."
                autofocus
            >
            <div id="statusMessage" class="mt-3 text-sm font-medium h-5"></div>
        </div>
        
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
             <button
                id="completeCheckButton"
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-xl hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 transform hover:scale-[1.01]"
            >
                Complete Check & Find Discrepancies
            </button>
            <button
                id="clearAllButton"
                class="w-full md:w-1/2 px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 transform hover:scale-[1.01]"
            >
                Clear All Scans
            </button>
        </div>

        <div class="mb-8 p-4 bg-gray-100 border-2 border-gray-200 rounded-xl shadow-inner">
            <label for="colleagueNameInput" class="block text-lg font-semibold text-gray-700 mb-2">
                Report Sign-off / Checked By:
            </label>
            <input
                type="text"
                id="colleagueNameInput"
                class="w-full px-4 py-2 text-md border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                placeholder="Enter your name to sign off the report..."
            >
        </div>
        <div class="mb-4">
            <label for="filterInput" class="block text-sm font-semibold text-gray-700 mb-2">
                Filter Stock List (Search by ID, Product, etc.):
            </label>
            <input
                type="text"
                id="filterInput"
                class="w-full px-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                placeholder="Start typing to filter visible rows..."
            >
        </div>

        <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200" id="stockTable">
                <thead class="bg-gray-50 sticky top-0" id="stockTableHeader">
                    <tr>
                        </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="stockTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 transform transition-all duration-300">
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <h3 class="text-2xl font-bold text-indigo-800">How to Use This System</h3>
                    <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="py-4 max-h-[70vh] overflow-y-auto space-y-4 text-gray-700">
                    
                    <h4 class="font-semibold text-lg text-gray-900">Session Persistence & Sign-off üíæ</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                        <li>The entire state (stock list, all scans, unexpected items, and your name) is **saved locally** in your browser.</li>
                        <li>You can close the page and reopen it to resume your work exactly where you left off.</li>
                        <li>Use the **"Report Sign-off / Checked By"** box to enter your name for accountability. This name will appear on all printed reports.</li>
                        <li>Use the **"Full Reset"** button next to the Load Data button to completely clear the app's memory and start fresh.</li>
                    </ul>

                    <h4 class="font-semibold text-lg text-gray-900">Step 1: Prepare Your Stock Sheet</h4>
                    <p class="text-sm">
                        Ensure your spreadsheet has a **header row** (the first row with column titles) and the data below it. The system automatically detects all columns.
                    </p>

                    <h4 class="font-semibold text-lg text-gray-900">Step 2: Paste Data & Review Headers</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                        <li>Copy **all** your spreadsheet data (including the header row) and paste it into the **"2. Paste Data"** text area.</li>
                        <li>The system will automatically **suggest headers** for the Unique ID, Quantity, and Price.</li>
                        <li>**Crucially:** Review the suggested headers in **"1. Review Auto-Detected Headers"** and correct them if needed.</li>
                    </ul>

                    <h4 class="font-semibold text-lg text-gray-900">Step 3: Scan & Filter</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                         <li>If you are **training or testing** the system, use the button below to load generic data.</li>
                        <li>
                            <button
                                id="loadDemoButton"
                                class="mt-2 px-5 py-2 text-sm font-semibold rounded-lg bg-yellow-600 text-white hover:bg-yellow-700 transition duration-150 shadow-md"
                                onclick="document.getElementById('helpModal').classList.add('hidden'); initializeWithInitialData(); updateDemoBadge(); saveState(); showLoadMessage('Demo data loaded successfully. Ready for training scans.', 'text-yellow-700'); scannerInput.focus();"
                            >
                                Load Demo Data Now
                            </button>
                        </li>
                        <li>Click the **"Load Data & Clear Scans"** button (or the Demo Data button above) to apply the list.</li>
                        <li>Scan an item to increment its **Scanned** count. Items not found are logged as "Unexpected".</li>
                        <li>Use the **"Filter Stock List"** box to quickly search for items by SKU, name, or any other detail.</li>
                    </ul>

                    <h4 class="font-semibold text-lg text-gray-900">Step 4: Complete Check & Reporting üìä</h4>
                    <p class="text-sm">
                        Click **"Complete Check & Find Discrepancies"** when finished. A modal will appear showing:
                    </p>
                    <ul class="list-disc list-inside space-y-1 ml-6 text-sm">
                        <li>A **Financial Discrepancy Summary** (if a Price column was loaded).</li>
                        <li>A list of all **Missing Items** (understocked).</li>
                        <li>A list of all **Unexpected Items** (over-scans/unlisted items).</li>
                        <li>Buttons to **Print** or **Export** these lists (CSV/JSON).</li>
                    </ul>
                </div>

                <div class="pt-4 border-t border-gray-200 flex justify-end">
                    <button 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150"
                        onclick="document.getElementById('helpModal').classList.add('hidden')"
                    >
                        Got It
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="discrepancyModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 transform transition-all duration-300">
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800">Inventory Discrepancy Report</h3>
                    <button onclick="document.getElementById('discrepancyModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div id="modalContent" class="py-4 max-h-[70vh] overflow-y-auto">
                    </div>

                <div class="pt-4 border-t border-gray-200 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 flex-wrap">
                    <button 
                        id="printListButton"
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition duration-150"
                        onclick="printMissingItems()"
                    >
                        Print Missing Items
                    </button>
                    <button 
                        id="printUnexpectedButton"
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-yellow-600 text-white hover:bg-yellow-700 transition duration-150"
                        onclick="printUnexpectedList()"
                    >
                        Print Unexpected Items
                    </button>
                    <button 
                        id="exportFullListJSONButton" 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition duration-150"
                        onclick="exportFullListJSON()"
                    >
                        Export Full List (JSON)
                    </button>
                    <button 
                        id="exportFullListModalButton" 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-150"
                        onclick="exportFullList()"
                    >
                        Export Full List (CSV)
                    </button>
                    <button 
                        id="exportUnexpectedButton"
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-150"
                        onclick="exportUnexpectedItems()"
                    >
                        Export Unexpected Items (CSV)
                    </button>
                    <button 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150"
                        onclick="document.getElementById('discrepancyModal').classList.add('hidden')"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
</body>
</html>