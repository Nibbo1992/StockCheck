<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stock Check Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for permanent background color persistence */
        .scanned-row {
            transition: background-color 0.3s ease;
            /* Applies when scan count >= expected quantity */
            background-color: #d1fae5; /* Light green */
        }
        .scanned-cell {
            background-color: #34d399 !important; /* Tailwind green-400 */
            color: #065f46; /* Tailwind green-900 */
            font-weight: 600;
        }
        /* New style for the ephemeral flash on scan */
        .scan-flash {
            background-color: #6ee7b7 !important; /* Brighter green */
        }
        /* Custom font for a clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Styles for printing the FULL discrepancy report */
        @media print {
            body > *:not(.full-print-report) { /* <-- NEW TARGET CLASS: Hide everything except the dedicated print container */
                display: none;
            }
            .full-print-report { /* <-- NEW PRINT CONTAINER CLASS */
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                padding: 20px;
                font-family: Arial, sans-serif; /* Ensure a standard readable font for print */
                color: #000 !important; /* Force black text for contrast */
            }
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            .print-table h2 {
                font-size: 16pt;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 10px;
            }
            .print-table th, .print-table td {
                border: 1px solid #000; /* Darker borders for better separation */
                padding: 6px 8px; 
                text-align: left;
                font-size: 11pt; /* <-- FIX: Increased font size for readability */
                background-color: transparent !important; /* Remove light colors/highlights */
                color: #000 !important; /* Force black text */
            }
            .print-table th {
                background-color: #eee !important;
                font-weight: bold;
            }
            /* Ensure the financial summary prints correctly */
            #financial-summary-print {
                padding: 15px;
                border: 1px solid #000;
                border-radius: 4px;
                margin-bottom: 20px;
            }
            #financial-summary-print h3 {
                font-size: 14pt;
                font-weight: bold;
            }
            /* Print Status Overrides (ensure status badges are high-contrast black/white) */
            .print-table td span {
                background-color: transparent !important;
                color: #000 !important;
                border: 1px solid #555; /* Add a border for demarcation */
                padding: 1px 4px;
                border-radius: 4px;
                box-shadow: none !important;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-8">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center space-x-3">
                <h1 class="text-3xl font-bold text-gray-800">Live Inventory Check</h1>
                <span id="demoModeBadge" class="hidden px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300 shadow-sm">
                    ‚ö†Ô∏è DEMO DATA LOADED
                </span>
            </div>
            <button
                onclick="document.getElementById('helpModal').classList.remove('hidden')"
                class="px-4 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition duration-150 text-sm"
            >
                How to Use
            </button>
        </div>
        <p class="text-gray-500 mb-6">Scan items below to match against expected stock list. **All highlights are permanent.**</p>

        <div class="mb-8 p-4 bg-gray-50 border-2 border-gray-200 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">
                Load New Stock List
            </h2>

            <div class="mb-4 p-4 border border-gray-300 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Review Auto-Detected Headers (Modify if needed)</h3>
                <p class="text-xs text-gray-500 mb-3">
                    Paste your data first, and the system will attempt to automatically fill these fields. **Ensure they are correct** before clicking 'Load Data'.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label for="uniqueIdHeaderNameInput" class="block text-xs font-medium text-gray-700">Unique Product/SKU Header (Required)</label>
                        <input type="text" id="uniqueIdHeaderNameInput" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., SKU, Barcode, Model, IMEI">
                    </div>
                    <div>
                        <label for="quantityHeaderNameInput" class="block text-xs font-medium text-gray-700">Expected Quantity Header (Optional)</label>
                        <input type="text" id="quantityHeaderNameInput" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Qty, Count. Leave blank for single-item asset tracking.">
                    </div>
                    <div>
                        <label for="priceHeaderNameInput" class="block text-xs font-medium text-gray-700">Unit Price/Cost Header (Optional)</label>
                        <input type="text" id="priceHeaderNameInput" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Price, Cost, Retail">
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Paste Data</h3>
            <p class="text-sm text-gray-500 mb-3">
                Paste your full spreadsheet data, **including the header row**, into the box below.
            </p>
            <textarea
                id="stockDataTextarea"
                rows="5"
                class="w-full p-3 text-sm font-mono border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                placeholder="Paste your spreadsheet data here..."
            ></textarea>
            
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3 mt-3">
                <button
                    id="loadDataButton"
                    class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150"
                >
                    Load Data & Clear Scans
                </button>
                <button
                    id="resetAppButton"
                    class="w-full md:w-auto px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition duration-150"
                >
                    <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0A8.003 8.003 0 0120 13c0-3.313-2.403-6.04-5.557-6.557M4 12a8 8 0 0115.418-3m-15.356 2A8.001 8.001 0 0119.418 15m0 0H15"></path></svg>
                    Full Reset
                </button>
            </div>
            <div id="loadStatusMessage" class="mt-3 text-sm font-medium h-5"></div>
        </div>

        <div class="mb-8 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl shadow-lg">
            
            <div class="mb-4 p-3 bg-white border border-indigo-300 rounded-lg shadow-inner">
                <p class="text-xs font-semibold uppercase text-indigo-600">Last Scanned Item ID (Success)</p>
                <p id="lastScannedDisplay" class="text-2xl font-bold font-mono text-indigo-800 break-words">N/A</p>
            </div>

            <label for="scannerInput" class="block text-lg font-semibold text-indigo-800 mb-2">
                Scan Unique Identifier Here:
            </label>
            <input
                type="text"
                id="scannerInput"
                class="w-full px-4 py-3 text-xl font-mono border-4 border-indigo-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150"
                placeholder="Type or scan the unique identifier and hit Enter..."
                autofocus
            >
            <div id="statusMessage" class="mt-3 text-sm font-medium h-5"></div>
        </div>
        
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
             <button
                id="completeCheckButton"
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-xl hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 transform hover:scale-[1.01]"
            >
                Complete Check & Find Discrepancies
            </button>
            <button
                id="clearAllButton"
                class="w-full md:w-1/2 px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 transform hover:scale-[1.01]"
            >
                Clear All Scans
            </button>
        </div>

        <div class="mb-8 p-4 bg-gray-100 border-2 border-gray-200 rounded-xl shadow-inner">
            <label for="colleagueNameInput" class="block text-lg font-semibold text-gray-700 mb-2">
                Report Sign-off / Checked By:
            </label>
            <input
                type="text"
                id="colleagueNameInput"
                class="w-full px-4 py-2 text-md border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                placeholder="Enter your name to sign off the report..."
            >
        </div>
        <div class="mb-4">
            <label for="filterInput" class="block text-sm font-semibold text-gray-700 mb-2">
                Filter Stock List (Search by ID, Product, etc.):
            </label>
            <input
                type="text"
                id="filterInput"
                class="w-full px-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                placeholder="Start typing to filter visible rows..."
            >
        </div>

        <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200" id="stockTable">
                <thead class="bg-gray-50 sticky top-0" id="stockTableHeader">
                    <tr>
                        </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="stockTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 transform transition-all duration-300">
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <h3 class="text-2xl font-bold text-indigo-800">How to Use This System</h3>
                    <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="py-4 max-h-[70vh] overflow-y-auto space-y-4 text-gray-700">
                    
                    <h4 class="font-semibold text-lg text-gray-900">Session Persistence & Sign-off üíæ</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                        <li>The entire state (stock list, all scans, unexpected items, and your name) is **saved locally** in your browser.</li>
                        <li>You can close the page and reopen it to resume your work exactly where you left off.</li>
                        <li>Use the **"Report Sign-off / Checked By"** box to enter your name for accountability. This name will appear on all printed reports.</li>
                        <li>Use the **"Full Reset"** button next to the Load Data button to completely clear the app's memory and start fresh.</li>
                    </ul>

                    <h4 class="font-semibold text-lg text-gray-900">Step 1: Prepare Your Stock Sheet</h4>
                    <p class="text-sm">
                        Ensure your spreadsheet has a **header row** (the first row with column titles) and the data below it. The system automatically detects all columns.
                    </p>

                    <h4 class="font-semibold text-lg text-gray-900">Step 2: Paste Data & Review Headers</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                        <li>Copy **all** your spreadsheet data (including the header row) and paste it into the **"2. Paste Data"** text area.</li>
                        <li>The system will automatically **suggest headers** for the Unique ID, Quantity, and Price.</li>
                        <li>**Crucially:** Review the suggested headers in **"1. Review Auto-Detected Headers"** and correct them if needed.</li>
                    </ul>

                    <h4 class="font-semibold text-lg text-gray-900">Step 3: Scan & Filter</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                         <li>If you are **training or testing** the system, use the button below to load generic data.</li>
                        <li>
                            <button
                                id="loadDemoButton"
                                class="mt-2 px-5 py-2 text-sm font-semibold rounded-lg bg-yellow-600 text-white hover:bg-yellow-700 transition duration-150 shadow-md"
                                onclick="document.getElementById('helpModal').classList.add('hidden'); initializeWithInitialData(); updateDemoBadge(); saveState(); showLoadMessage('Demo data loaded successfully. Ready for training scans.', 'text-yellow-700'); scannerInput.focus();"
                            >
                                Load Demo Data Now
                            </button>
                        </li>
                        <li>Click the **"Load Data & Clear Scans"** button (or the Demo Data button above) to apply the list.</li>
                        <li>Scan an item to increment its **Scanned** count. Items not found are logged as "Unexpected".</li>
                        <li>Use the **"Filter Stock List"** box to quickly search for items by SKU, name, or any other detail.</li>
                    </ul>

                    <h4 class="font-semibold text-lg text-gray-900">Step 4: Complete Check & Reporting üìä</h4>
                    <p class="text-sm">
                        Click **"Complete Check & Find Discrepancies"** when finished. A modal will appear showing:
                    </p>
                    <ul class="list-disc list-inside space-y-1 ml-6 text-sm">
                        <li>A **Financial Discrepancy Summary** (if a Price column was loaded).</li>
                        <li>A list of all **Missing Items** (understocked).</li>
                        <li>A list of all **Unexpected Items** (over-scans/unlisted items).</li>
                        <li>Buttons to **Print** or **Export** these lists (CSV/JSON).</li>
                    </ul>
                </div>

                <div class="pt-4 border-t border-gray-200 flex justify-end">
                    <button 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150"
                        onclick="document.getElementById('helpModal').classList.add('hidden')"
                    >
                        Got It
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="discrepancyModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 transform transition-all duration-300">
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800">Inventory Discrepancy Report</h3>
                    <button onclick="document.getElementById('discrepancyModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div id="modalContent" class="py-4 max-h-[70vh] overflow-y-auto">
                    </div>

                <div class="pt-4 border-t border-gray-200 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 flex-wrap">
                    <button 
                        id="printFullReportButton"
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-150"
                        onclick="printFullReport()"
                    >
                        Print Full Inventory Report
                    </button>
                    <button 
                        id="exportFullListJSONButton" 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition duration-150"
                        onclick="exportFullListJSON()"
                    >
                        Export Full List (JSON)
                    </button>
                    <button 
                        id="exportFullListModalButton" 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-150"
                        onclick="exportFullList()"
                    >
                        Export Full List (CSV)
                    </button>
                    <button 
                        id="exportUnexpectedButton"
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-150"
                        onclick="exportUnexpectedItems()"
                    >
                        Export Unexpected Items (CSV)
                    </button>
                    <button 
                        class="px-5 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150"
                        onclick="document.getElementById('discrepancyModal').classList.add('hidden')"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global array to hold the currently loaded expected stock data
        let expectedStock = [];
        let detectedHeaders = []; // Stores the headers detected from the pasted data
        let lastScannedId = 'N/A'; 
        let isDemoData = false; // NEW: Flag to track if the current data is the initial demo set
        
        let stockMap = new Map(); // Key: Normalized Unique ID, Value: Index in expectedStock
        let unexpectedScans = new Map(); // Key: Normalized ID, Value: { rawId: string, count: number }

        // --- GLOBAL STATE FOR CURRENCY & SIGN-OFF ---
        let detectedCurrencySymbol = '';
        let lastFinancialSummaryHTML = ''; // Stores the HTML for printing
        let colleagueName = ''; // Stores the name for sign-off

        // --- DOM ELEMENTS ---
        const stockTableBody = document.getElementById('stockTableBody');
        const stockTableHeader = document.getElementById('stockTableHeader');
        const scannerInput = document.getElementById('scannerInput');
        const statusMessage = document.getElementById('statusMessage');
        const stockDataTextarea = document.getElementById('stockDataTextarea');
        const loadDataButton = document.getElementById('loadDataButton');
        const loadStatusMessage = document.getElementById('loadStatusMessage');
        const lastScannedDisplay = document.getElementById('lastScannedDisplay');
        const completeCheckButton = document.getElementById('completeCheckButton');
        const clearAllButton = document.getElementById('clearAllButton');
        const discrepancyModal = document.getElementById('discrepancyModal');
        const modalContent = document.getElementById('modalContent');
        const filterInput = document.getElementById('filterInput'); 
        const demoModeBadge = document.getElementById('demoModeBadge'); // NEW: Badge element
        
        // Dynamic Mapping Input
        const uniqueIdHeaderNameInput = document.getElementById('uniqueIdHeaderNameInput');
        const quantityHeaderNameInput = document.getElementById('quantityHeaderNameInput'); 
        const priceHeaderNameInput = document.getElementById('priceHeaderNameInput'); 
        const colleagueNameInput = document.getElementById('colleagueNameInput');
        
        // --- GENERIC INITIAL DATA STRUCTURE (FOR DEMO/FIRST LOAD) ---
        const initialStockData = [
            { "Category": "Hardware", "Description": "Desktop PC - Model 7", "Asset ID": "PC-D7-4822", "Expected Quantity": "5", "Unit Price": "¬£1200.00", expectedQuantity: 5, scannedCount: 0, unitPrice: 1200.00, id: "PC-D7-4822", rawId: "PC-D7-4822" },
            { "Category": "Software", "Description": "Enterprise License Pack", "Asset ID": "SOFT-ENT-L9", "Expected Quantity": "15", "Unit Price": "‚Ç¨150.00", expectedQuantity: 15, scannedCount: 0, unitPrice: 150.00, id: "SOFT-ENT-L9", rawId: "SOFT-ENT-L9" },
            { "Category": "Consumable", "Description": "A4 Paper Pack - White", "Asset ID": "CON-PAP-A4", "Expected Quantity": "50", "Unit Price": "2.50", expectedQuantity: 50, scannedCount: 0, unitPrice: 2.50, id: "CON-PAP-A4", rawId: "CON-PAP-A4" },
            { "Category": "Tool", "Description": "Digital Multimeter", "Asset ID": "TOOL-DMM-01", "Expected Quantity": "2", "Unit Price": "99.99", expectedQuantity: 2, scannedCount: 0, unitPrice: 99.99, id: "TOOL-DMM-01", rawId: "TOOL-DMM-01" },
            { "Category": "Furniture", "Description": "Ergonomic Desk Chair", "Asset ID": "FURN-CHR-ERGO", "Expected Quantity": "3", "Unit Price": "¬£0.00", expectedQuantity: 3, scannedCount: 0, unitPrice: 0.00, id: "FURN-CHR-ERGO", rawId: "FURN-CHR-ERGO" },
        ];
        
        const initialHeaders = ["Category", "Description", "Asset ID", "Expected Quantity", "Unit Price"];
        // -------------------------------------------------------------------

        /**
         * Normalizes a unique ID string for consistent comparison.
         * @param {string} id The raw ID string.
         * @returns {string} The normalized ID.
         */
        function normalizeId(id) {
            return id.trim().toUpperCase();
        }

        /**
         * Detects the currency symbol from the raw price string.
         * @param {string} value The raw price string.
         * @returns {string} The detected symbol (e.g., '¬£', 'EUR'), or empty string.
         */
        function getCurrencySymbol(value) {
            if (!value) return '';
            const trimmedValue = value.trim();
            // Common symbols to look for at the start
            const commonSymbols = ['¬£', '‚Ç¨', '$', '¬•'];
            for (const symbol of commonSymbols) {
                if (trimmedValue.startsWith(symbol)) {
                    return symbol;
                }
            }
            // Look for common three-letter currency codes (case-insensitive)
            const commonCodes = ['GBP', 'EUR', 'USD', 'AUD', 'CAD', 'JPY'];
            for (const code of commonCodes) {
                 if (trimmedValue.toUpperCase().startsWith(code)) {
                    return code;
                }
            }

            // Fallback: Check for any single non-digit/non-decimal/non-sign character at the start
            const match = trimmedValue.match(/^[^0-9.-]/);
            if (match && match[0].length === 1) {
                return match[0];
            }
            
            return '';
        }

        /**
         * Cleans a string value (like price) by removing non-numeric characters (except . and -) and parses it to float.
         * @param {string} value The price string.
         * @returns {number} The parsed float, or 0 if invalid.
         */
        function cleanAndParseFloat(value) {
            if (!value) return 0;
            // Remove everything that isn't a digit, dot, or minus sign
            const cleanedValue = value.replace(/[^0-9.-]+/g,"");
            const parsed = parseFloat(cleanedValue);
            return isNaN(parsed) ? 0 : parsed;
        }

        /**
         * Formats a number as a currency string or raw number based on detection.
         * @param {number} amount The numerical amount.
         * @param {boolean} isCurrency Whether to treat this as a currency value.
         * @returns {string} The formatted string.
         */
        function formatValue(amount, isCurrency = false) {
            const formattedAmount = amount.toFixed(2);
            if (isCurrency && detectedCurrencySymbol) {
                // Prepend the detected symbol
                return `${detectedCurrencySymbol}${formattedAmount}`;
            }
            // Return raw number with 2 decimals if no symbol detected or not a currency
            return formattedAmount;
        }

        /**
         * Detects headers from raw text by splitting the first non-empty line.
         * @param {string} rawText The raw pasted data.
         * @returns {string[]} An array of detected header names.
         */
        function detectHeadersFromText(rawText) {
            const lines = rawText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            const firstLine = lines[0];
            const separator = firstLine.includes('\t') ? '\t' : ',';
            
            const headerParts = firstLine.split(separator);
            return headerParts.map(h => h.trim()).filter(h => h.length > 0);
        }

        /**
         * Attempts to match column headers to required fields based on common keywords.
         */
        function suggestHeaders(headers) {
            const normalizedHeaders = headers.map(h => h.trim().toLowerCase());
            
            // Common keywords for each field (most specific first)
            const uniqueIdKeywords = ['asset id', 'stock code', 'sku', 'id', 'barcode', 'code', 'product id', 'model'];
            const quantityKeywords = ['expected quantity', 'expected qty', 'qty', 'quantity', 'count', 'stock'];
            const priceKeywords = ['unit price', 'price', 'cost', 'value', 'rate', 'retail'];
            
            let suggestions = {
                uniqueId: '',
                quantity: '',
                price: ''
            };

            function findMatch(keywords) {
                for (const keyword of keywords) {
                    const matchIndex = normalizedHeaders.findIndex(h => h.includes(keyword));
                    if (matchIndex !== -1) {
                        return headers[matchIndex];
                    }
                }
                return '';
            }

            suggestions.uniqueId = findMatch(uniqueIdKeywords);
            suggestions.quantity = findMatch(quantityKeywords);
            suggestions.price = findMatch(priceKeywords);
            
            // Fallback for Unique ID if still not found: use the first column header.
            if (!suggestions.uniqueId && headers.length > 0) {
                 suggestions.uniqueId = headers[0];
            }


            return suggestions;
        }

        /**
         * Handles data input change (e.g., paste) to auto-detect and pre-fill headers.
         */
        function handleDataPaste() {
            const rawData = stockDataTextarea.value.trim();
            if (!rawData) return;
            
            const headers = detectHeadersFromText(rawData);
            if (headers.length === 0) return;

            // Only auto-detect if ALL three input fields are currently empty.
            const allInputsEmpty = !uniqueIdHeaderNameInput.value.trim() && !quantityHeaderNameInput.value.trim() && !priceHeaderNameInput.value.trim();

            if (allInputsEmpty) {
                const suggestions = suggestHeaders(headers);
                
                let detectedCount = 0;
                
                if (suggestions.uniqueId) {
                    uniqueIdHeaderNameInput.value = suggestions.uniqueId;
                    detectedCount++;
                }
                if (suggestions.quantity) {
                    quantityHeaderNameInput.value = suggestions.quantity;
                    detectedCount++;
                }
                if (suggestions.price) {
                    priceHeaderNameInput.value = suggestions.price;
                    detectedCount++;
                }
                
                if (detectedCount > 0) {
                    showLoadMessage(`‚úÖ Auto-detected ${detectedCount} header(s). Please review the fields above and click 'Load Data'.`, 'text-blue-600');
                } else {
                    showLoadMessage(`‚ö†Ô∏è No headers auto-detected. Please manually enter the correct column header names above.`, 'text-orange-600');
                }
            }
        }


        /**
         * Parses the raw CSV/TSV text, detects headers, and extracts data.
         */
        function parseCSV(rawText, uniqueIdHeaderName, quantityHeaderName, priceHeaderName) {
            const lines = rawText.trim().split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) { 
                return { data: [], headers: [] };
            }
            
            const firstLine = lines[0];
            const separator = firstLine.includes('\t') ? '\t' : ',';
            
            const headerParts = firstLine.split(separator);
            const headers = headerParts.map(h => h.trim()).filter(h => h.length > 0);
            
            const uniqueIdIndex = headers.findIndex(h => h.trim().toLowerCase() === uniqueIdHeaderName.trim().toLowerCase());
            const quantityIndex = quantityHeaderName.trim() 
                ? headers.findIndex(h => h.trim().toLowerCase() === quantityHeaderName.trim().toLowerCase()) 
                : -1; 
            const priceIndex = priceHeaderName.trim() 
                ? headers.findIndex(h => h.trim().toLowerCase() === priceHeaderName.trim().toLowerCase()) 
                : -1; 

            if (uniqueIdIndex === -1) {
                return { 
                    data: [], 
                    headers: [], 
                    error: `Unique ID Header "${uniqueIdHeaderName}" not found in the pasted data headers.`
                };
            }
            
            const dataLines = lines.slice(1);
            const parsedData = [];
            const idCheckSet = new Set(); 
            let currencyDetectedInParse = false; // Flag to stop checking currency after the first one is found

            dataLines.forEach((line, index) => {
                const parts = line.split(separator);
                
                if (parts.length >= headers.length) {
                    const uniqueId = parts[uniqueIdIndex].trim();

                    if (uniqueId.length > 0) {
                        const normalizedId = normalizeId(uniqueId); 

                        if (idCheckSet.has(normalizedId)) {
                            console.warn(`Skipping data line ${index + 1}: Duplicate ID detected for ${uniqueId}. Only the first instance is used.`);
                            return; 
                        }
                        idCheckSet.add(normalizedId);
                        
                        let expectedQty = 1; 
                        if (quantityIndex !== -1 && parts[quantityIndex]) {
                            const parsedQty = parseInt(parts[quantityIndex].trim());
                            expectedQty = isNaN(parsedQty) || parsedQty < 1 ? 1 : parsedQty;
                        }
                        
                        // Parse Price
                        let unitPrice = 0;
                        if (priceIndex !== -1 && parts[priceIndex]) {
                            const rawPrice = parts[priceIndex].trim();
                            unitPrice = cleanAndParseFloat(rawPrice);
                            
                            // *** CURRENCY DETECTION LOGIC ***
                            if (!currencyDetectedInParse && unitPrice > 0) {
                                detectedCurrencySymbol = getCurrencySymbol(rawPrice);
                                currencyDetectedInParse = true;
                            }
                            // ***********************************

                        }

                        const item = { 
                            expectedQuantity: expectedQty, 
                            scannedCount: 0,
                            unitPrice: unitPrice 
                        };
                        
                        item.id = normalizedId; 
                        item.rawId = uniqueId; 

                        headers.forEach((header, i) => {
                            if (parts[i]) {
                                item[header] = parts[i].trim();
                            } else {
                                item[header] = '';
                            }
                        });
                        
                        parsedData.push(item);
                    } else {
                        console.warn(`Skipping data line ${index + 1} due to empty unique ID in column: ${line}`);
                    }
                } else {
                    console.warn(`Skipping data line ${index + 1} due to insufficient columns: ${line}`);
                }
            });

            // Ensure quantity and price headers are included in detectedHeaders if provided
            const finalHeaders = [...headers];
            if (quantityHeaderName.trim() && !finalHeaders.map(h => h.toLowerCase()).includes(quantityHeaderName.trim().toLowerCase())) {
                 finalHeaders.push(quantityHeaderName.trim());
            }
            if (priceHeaderName.trim() && !finalHeaders.map(h => h.toLowerCase()).includes(priceHeaderName.trim().toLowerCase())) {
                 finalHeaders.push(priceHeaderName.trim());
            }

            return { data: parsedData, headers: finalHeaders };
        }


        /**
         * Loads data from the textarea, replaces the expectedStock, and re-renders the table.
         */
        function loadStockData() {
            const rawData = stockDataTextarea.value.trim();
            const uniqueIdHeaderName = uniqueIdHeaderNameInput.value.trim();
            const quantityHeaderName = quantityHeaderNameInput.value.trim(); 
            const priceHeaderName = priceHeaderNameInput.value.trim(); 

            if (!uniqueIdHeaderName) {
                showLoadMessage('ERROR: Please specify the Unique Product/SKU Header Name.', 'text-red-500');
                return;
            }

            if (!rawData) {
                showLoadMessage('Please paste data into the box first.', 'text-red-500');
                return;
            }

            // Ensure auto-detection has run to update the headers if inputs were empty
            handleDataPaste();

            // Reset currency symbol before parsing new data
            detectedCurrencySymbol = '';
            
            const result = parseCSV(rawData, uniqueIdHeaderName, quantityHeaderName, priceHeaderName);

            if (result.error) {
                showLoadMessage(`ERROR: ${result.error}`, 'text-red-500');
                return;
            }

            if (result.data.length === 0) {
                showLoadMessage('No valid stock items found. Check your pasted data and Unique ID Header Name.', 'text-red-500');
                return;
            }

            expectedStock = result.data;
            detectedHeaders = result.headers;
            isDemoData = false; // NEW: Set to false as real data is loaded

            stockMap.clear();
            expectedStock.forEach((item, index) => {
                stockMap.set(item.id, index);
            });
            unexpectedScans.clear();
            stockDataTextarea.value = '';
            lastScannedId = 'N/A';
            lastScannedDisplay.textContent = lastScannedId;

            renderTable();
            saveState();
            updateDemoBadge(); // NEW: Update the badge display

            const totalExpectedQty = expectedStock.reduce((total, item) => total + item.expectedQuantity, 0);
            let currencyMsg = '';
            if (priceHeaderName && detectedCurrencySymbol) {
                currencyMsg = ` (Detected currency: **${detectedCurrencySymbol}**).`;
            } else if (priceHeaderName) {
                currencyMsg = ` (Price column loaded, but no currency symbol detected. Displaying raw number).`;
            }

            showLoadMessage(`Successfully loaded ${expectedStock.length} unique items (${totalExpectedQty} total quantity) with ${detectedHeaders.length} columns.${currencyMsg} Ready to scan!`, 'text-green-600');
            scannerInput.focus();
        }

        /**
         * Renders the expected stock data into the HTML table dynamically.
         */
        function renderTable() {
            stockTableBody.innerHTML = '';
            stockTableHeader.innerHTML = '';

            if (expectedStock.length === 0) {
                stockTableBody.innerHTML = '<tr><td colspan="10" class="p-6 text-center text-gray-500">No stock data loaded. Please use the "Load New Stock List" section above.</td></tr>';
                return;
            }

            const headerRow = stockTableHeader.insertRow();

            detectedHeaders.forEach(header => {
                const th = document.createElement('th');
                th.classList.add('px-3', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            const fixedHeaders = ['Expected', 'Scanned', 'Remaining', 'Status'];
            fixedHeaders.forEach(text => {
                const th = document.createElement('th');
                th.classList.add('px-3', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const uniqueIdHeaderName = uniqueIdHeaderNameInput.value.trim();

            expectedStock.forEach(item => {
                const row = stockTableBody.insertRow();
                row.id = `row-${item.id}`;

                const remaining = item.expectedQuantity - item.scannedCount;
                const isComplete = remaining <= 0;

                row.classList.add('hover:bg-gray-50');
                // Create a data attribute for fast filtering
                row.dataset.search = Object.values(item).join(' ').toUpperCase();

                if (isComplete) {
                    row.classList.add('scanned-row');
                }

                detectedHeaders.forEach(header => {
                    const cell = row.insertCell();
                    cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    cell.textContent = item[header] || '';
                    
                    if (header.toLowerCase() === uniqueIdHeaderName.toLowerCase()) {
                        cell.id = `id-cell-${item.id}`;
                        cell.textContent = item.rawId || item[header] || '';
                        cell.classList.add('font-mono');
                        if (isComplete) {
                            cell.classList.add('scanned-cell');
                        } else {
                            cell.classList.add('text-gray-700');
                        }
                    }
                });

                let cell = row.insertCell();
                cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm', 'font-semibold', 'text-blue-700');
                cell.textContent = item.expectedQuantity;

                cell = row.insertCell();
                cell.id = `scanned-count-cell-${item.id}`;
                cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm', 'font-semibold');
                cell.classList.add(item.scannedCount > item.expectedQuantity ? 'text-red-600' : 'text-green-600');
                cell.textContent = item.scannedCount;

                cell = row.insertCell();
                cell.id = `remaining-cell-${item.id}`;
                cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm', 'font-semibold');
                cell.classList.add(remaining > 0 ? 'text-red-600' : 'text-green-600');
                cell.textContent = remaining > 0 ? remaining : 0;

                cell = row.insertCell();
                cell.id = `status-cell-${item.id}`;
                cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm');

                let statusHTML = '';
                if (remaining === item.expectedQuantity) {
                    statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">PENDING</span>';
                } else if (remaining > 0) {
                    statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">PARTIAL</span>';
                } else if (remaining === 0) {
                    statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-200 text-green-800 shadow-md">COMPLETE</span>';
                } else if (remaining < 0) {
                    statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-200 text-red-800 shadow-md">OVER-SCAN</span>';
                }
                
                cell.innerHTML = statusHTML;
            });
        }

        /**
         * Handles the input from the scanner/keyboard.
         */
        function handleScan(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Stop form submission
                const rawScannedId = scannerInput.value.trim();
                scannerInput.value = ''; // Clear the input immediately

                if (expectedStock.length === 0) {
                    showMessage('Load a stock list first using the section above.', 'text-red-500');
                    return;
                }

                if (!rawScannedId) {
                    showMessage('Input is empty.', 'text-red-500');
                    return;
                }

                const scannedId = normalizeId(rawScannedId);
                const itemIndex = stockMap.get(scannedId);
                
                if (typeof itemIndex !== 'undefined') {
                    // ITEM FOUND IN EXPECTED LIST
                    const matchedItem = expectedStock[itemIndex];
                    matchedItem.scannedCount++;

                    let remaining = matchedItem.expectedQuantity - matchedItem.scannedCount;

                    let statusMessageText = '';
                    let statusMessageClass = 'text-green-600';

                    if (remaining >= 0) {
                         statusMessageText = `SUCCESS: Item ${rawScannedId} checked in. ${remaining} remaining.`;
                    } else if (remaining === -1) {
                         statusMessageText = `‚ö†Ô∏è OVER-SCAN ALERT: Item ${rawScannedId} is now over its expected quantity of ${matchedItem.expectedQuantity}.`;
                         statusMessageClass = 'text-red-600 font-bold';
                    } else {
                         statusMessageText = `‚ö†Ô∏è OVER-SCAN ALERT: Item ${rawScannedId} scanned again. Count is now ${matchedItem.scannedCount} (Expected ${matchedItem.expectedQuantity}).`;
                         statusMessageClass = 'text-red-600 font-bold';
                    }

                    // Update the table row in DOM
                    const rowElement = document.getElementById(`row-${scannedId}`);
                    const idCellElement = document.getElementById(`id-cell-${scannedId}`);
                    const scannedCountCell = document.getElementById(`scanned-count-cell-${scannedId}`);
                    const remainingCell = document.getElementById(`remaining-cell-${scannedId}`);
                    const statusCell = document.getElementById(`status-cell-${scannedId}`);

                    if (rowElement && idCellElement) {
                        scannedCountCell.textContent = matchedItem.scannedCount;
                        remainingCell.textContent = remaining > 0 ? remaining : 0;
                        
                        // Update remaining cell color
                        remainingCell.classList.remove('text-red-600', 'text-green-600');
                        remainingCell.classList.add(remaining > 0 ? 'text-red-600' : 'text-green-600');
                        
                        // Update scanned count color
                        scannedCountCell.classList.remove('text-red-600', 'text-green-600');
                        scannedCountCell.classList.add(matchedItem.scannedCount > matchedItem.expectedQuantity ? 'text-red-600' : 'text-green-600');

                        // Update status indicator
                        let statusHTML = '';
                        if (remaining === matchedItem.expectedQuantity) {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">PENDING</span>';
                        } else if (remaining > 0) {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">PARTIAL</span>';
                        } else if (remaining === 0) {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-200 text-green-800 shadow-md">COMPLETE</span>';
                        } else if (remaining < 0) {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-200 text-red-800 shadow-md">OVER-SCAN</span>';
                        }
                        statusCell.innerHTML = statusHTML;

                        // Apply permanent highlight if completed or over-scanned
                        if (remaining <= 0) {
                            rowElement.classList.add('scanned-row');
                            idCellElement.classList.add('scanned-cell');
                        } else {
                            rowElement.classList.remove('scanned-row');
                            idCellElement.classList.remove('scanned-cell');
                        }

                        // Flash the row green briefly
                        rowElement.classList.add('scan-flash');
                        setTimeout(() => {
                            rowElement.classList.remove('scan-flash');
                        }, 300);
                        
                    }

                    lastScannedId = rawScannedId;
                    lastScannedDisplay.textContent = lastScannedId;
                    showMessage(statusMessageText, statusMessageClass);

                } else {
                    // ITEM NOT FOUND IN EXPECTED LIST (UNEXPECTED)
                    const existingItem = unexpectedScans.get(scannedId);
                    
                    if (existingItem) {
                        existingItem.count++;
                    } else {
                        unexpectedScans.set(scannedId, { rawId: rawScannedId, count: 1 });
                    }

                    lastScannedId = rawScannedId;
                    lastScannedDisplay.textContent = lastScannedId;
                    const count = existingItem ? existingItem.count : 1;
                    showMessage(`üö® UNEXPECTED ITEM: ${rawScannedId} scanned. Count is now ${count}.`, 'text-red-600 font-bold');
                }

                saveState();
            }
        }

        /**
         * Clears all scan counts in expectedStock and the unexpectedScans map, and updates the UI.
         */
        function clearAllScans() {
             if (!confirm("Are you sure you want to clear ALL scan counts and unexpected items? This action cannot be undone for the current session data.")) {
                return;
            }

            expectedStock.forEach(item => {
                item.scannedCount = 0;
            });
            unexpectedScans.clear();
            
            lastScannedId = 'N/A';
            lastScannedDisplay.textContent = lastScannedId;

            renderTable();
            saveState();
            showMessage('All scan counts and unexpected items have been cleared.', 'text-green-600');
            scannerInput.focus();
        }

        /**
         * Calculates discrepancies, generates the report HTML, and displays the modal.
         */
        function completeCheck() {
            if (expectedStock.length === 0) {
                showMessage('Please load a stock list before running the check.', 'text-red-500');
                return;
            }

            const missingItems = expectedStock.filter(item => item.scannedCount < item.expectedQuantity);
            const unexpectedItemsArray = Array.from(unexpectedScans.values());

            let totalExpectedValue = 0;
            let totalScannedValue = 0;
            let totalMissingValue = 0;
            let totalOverValue = 0;
            let hasPriceData = expectedStock.some(item => item.unitPrice > 0);

            // Calculate financial summary
            if (hasPriceData) {
                expectedStock.forEach(item => {
                    totalExpectedValue += item.expectedQuantity * item.unitPrice;
                    totalScannedValue += item.scannedCount * item.unitPrice;
                });
                
                // Calculate missing/over value from expected list
                missingItems.forEach(item => {
                    const missingQty = item.expectedQuantity - item.scannedCount;
                    totalMissingValue += missingQty * item.unitPrice;
                });
                
                // Calculate over-scanned value (items scanned > expected)
                 expectedStock.filter(item => item.scannedCount > item.expectedQuantity).forEach(item => {
                    const overQty = item.scannedCount - item.expectedQuantity;
                    totalOverValue += overQty * item.unitPrice;
                });
            }

            // --- 1. FINANCIAL SUMMARY ---
            let financialSummaryHTML = '';
            if (hasPriceData) {
                const totalDiscrepancyValue = (totalScannedValue - totalExpectedValue) + totalOverValue;

                financialSummaryHTML = `
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-md" id="financial-summary-print">
                        <h3 class="text-xl font-bold text-yellow-800 mb-3">üí∞ Financial Discrepancy Summary</h3>
                        <div class="grid grid-cols-2 gap-4 text-gray-800">
                            <div class="border-b border-yellow-200 pb-2">
                                <p class="text-sm font-semibold">Total Expected Value (Cost)</p>
                                <p class="text-lg font-bold text-blue-700">${formatValue(totalExpectedValue, true)}</p>
                            </div>
                            <div class="border-b border-yellow-200 pb-2">
                                <p class="text-sm font-semibold">Total Scanned Value (Against Expected)</p>
                                <p class="text-lg font-bold text-green-700">${formatValue(totalScannedValue, true)}</p>
                            </div>
                            <div class="pb-2">
                                <p class="text-sm font-semibold">Value of Missing Items (Loss)</p>
                                <p class="text-lg font-bold text-red-700">${formatValue(totalMissingValue, true)}</p>
                            </div>
                            <div class="pb-2">
                                <p class="text-sm font-semibold">Net Discrepancy Value (Scanned - Expected)</p>
                                <p class="text-xl font-extrabold ${totalDiscrepancyValue < 0 ? 'text-red-700' : 'text-green-700'}">${totalDiscrepancyValue < 0 ? '-' : ''}${formatValue(Math.abs(totalDiscrepancyValue), true)}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                 financialSummaryHTML = `
                    <div class="mb-6 p-4 bg-gray-100 border border-gray-300 rounded-lg shadow-md" id="financial-summary-print">
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Financial Summary Not Available</h3>
                        <p class="text-sm text-gray-500">No Unit Price/Cost column was loaded, so a financial summary cannot be calculated.</p>
                    </div>
                 `;
            }
            lastFinancialSummaryHTML = financialSummaryHTML; // Store for printing

            let modalHTML = financialSummaryHTML;

            // --- 2. MISSING ITEMS LIST ---
            modalHTML += `
                <h3 class="text-2xl font-bold text-red-700 mt-6 mb-3">üî¥ Missing Items (${missingItems.length} Unique Items)</h3>
                <p class="text-gray-600 mb-4">These items have a final scanned count less than their expected quantity.</p>
            `;

            if (missingItems.length > 0) {
                const missingHeaders = detectedHeaders.filter(h => h.trim().toLowerCase() !== uniqueIdHeaderNameInput.value.trim().toLowerCase());
                const headerRow = missingHeaders.map(h => `<th class="py-2 px-4 bg-red-50 text-left text-xs font-semibold text-red-800 uppercase tracking-wider">${h}</th>`).join('');
                
                modalHTML += `
                    <div class="overflow-x-auto border border-red-200 rounded-lg mb-8">
                        <table class="min-w-full divide-y divide-red-200 print-table">
                            <thead>
                                <tr>
                                    ${headerRow}
                                    <th class="py-2 px-4 bg-red-50 text-left text-xs font-semibold text-red-800 uppercase tracking-wider">Expected</th>
                                    <th class="py-2 px-4 bg-red-50 text-left text-xs font-semibold text-red-800 uppercase tracking-wider">Scanned</th>
                                    <th class="py-2 px-4 bg-red-50 text-left text-xs font-semibold text-red-800 uppercase tracking-wider">Missing</th>
                                    ${hasPriceData ? '<th class="py-2 px-4 bg-red-50 text-left text-xs font-semibold text-red-800 uppercase tracking-wider">Unit Price</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-red-100">
                `;

                missingItems.forEach(item => {
                    const rowData = missingHeaders.map(h => `<td class="py-2 px-4 whitespace-nowrap text-sm text-gray-800">${item[h] || ''}</td>`).join('');
                    const missingQty = item.expectedQuantity - item.scannedCount;
                    
                    modalHTML += `
                        <tr>
                            ${rowData}
                            <td class="py-2 px-4 whitespace-nowrap text-sm font-semibold text-blue-700">${item.expectedQuantity}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-sm font-semibold text-green-700">${item.scannedCount}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-sm font-bold text-red-700">${missingQty}</td>
                            ${hasPriceData ? `<td class="py-2 px-4 whitespace-nowrap text-sm text-gray-800">${formatValue(item.unitPrice, true)}</td>` : ''}
                        </tr>
                    `;
                });

                modalHTML += '</tbody></table></div>';
            } else {
                modalHTML += '<p class="text-green-600 font-semibold mb-8">‚úÖ No expected items were found to be missing!</p>';
            }

            // --- 3. UNEXPECTED ITEMS LIST ---
            modalHTML += `
                <h3 class="text-2xl font-bold text-orange-700 mt-6 mb-3">‚ö†Ô∏è Unexpected Scans (${unexpectedItemsArray.length} Unique Items)</h3>
                <p class="text-gray-600 mb-4">These items were scanned but are not present in the expected stock list. This may indicate unlisted stock or incorrect scans.</p>
            `;

            if (unexpectedItemsArray.length > 0) {
                 modalHTML += `
                    <div class="overflow-x-auto border border-orange-200 rounded-lg mb-8">
                        <table class="min-w-full divide-y divide-orange-200 print-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 bg-orange-50 text-left text-xs font-semibold text-orange-800 uppercase tracking-wider">Unexpected ID</th>
                                    <th class="py-2 px-4 bg-orange-50 text-left text-xs font-semibold text-orange-800 uppercase tracking-wider">Scanned Count</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-orange-100">
                `;

                unexpectedItemsArray.forEach(item => {
                    modalHTML += `
                        <tr>
                            <td class="py-2 px-4 whitespace-nowrap text-sm font-mono text-gray-800">${item.rawId}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-sm font-bold text-red-700">${item.count}</td>
                        </tr>
                    `;
                });

                modalHTML += '</tbody></table></div>';
            } else {
                modalHTML += '<p class="text-green-600 font-semibold mb-8">‚úÖ No unexpected items were scanned!</p>';
            }
            

            modalContent.innerHTML = modalHTML;
            discrepancyModal.classList.remove('hidden');
        }

        /**
         * @MODIFIED: Prints a single, comprehensive report of all sections.
         */
        function printFullReport() {
            // 1. Get the current state
            const name = colleagueNameInput.value.trim() || 'Unsigned';
            const date = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            // 2. Prepare the main printable container
            let printWindow = window.open('', '_blank', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Full Inventory Report</title>');
            
            // Copy the print styles over
            const styleContent = document.querySelector('style').textContent;
            printWindow.document.write(`<style>${styleContent}</style>`);
            printWindow.document.write('</head><body>');
            
            // Create the full report container that the CSS targets
            printWindow.document.write('<div class="full-print-report">'); 

            // 3. Add Header and Sign-off
            printWindow.document.write(`
                <h1 style="font-size: 20pt; margin-bottom: 5px;">Full Inventory Check Report</h1>
                <p style="margin-bottom: 20px; font-size: 10pt; font-weight: bold;">
                    Date/Time: ${date} at ${time} | 
                    Checked By: ${name}
                </p>
            `);
            
            // 4. Add Financial Summary (if generated)
            if (lastFinancialSummaryHTML) {
                printWindow.document.write(`
                    <div id="financial-summary-print" style="margin-bottom: 20px; padding: 10px; border: 1px solid #000;">
                        ${lastFinancialSummaryHTML}
                    </div>
                `);
            }

            // 5. Add Full Stock List (Expected Items with Status)
            printWindow.document.write('<h2 style="font-size: 16pt; margin-top: 20px; margin-bottom: 10px; font-weight: bold;">1. Expected Inventory Status (All Items)</h2>');
            
            // Clone the main table
            const originalTable = document.getElementById('stockTable').cloneNode(true);
            
            // Apply print-friendly classes and cleanup dynamic classes
            originalTable.classList.remove('min-w-full', 'divide-y', 'divide-gray-200');
            originalTable.classList.add('print-table'); // Apply table print styles
            originalTable.style.width = '100%'; // Ensure full width

            // Clean up row classes for print (remove hover/color which mess with print styles)
            originalTable.querySelectorAll('tr').forEach(row => {
                row.classList.remove('scanned-row', 'hover:bg-gray-50', 'scan-flash');
            });
            originalTable.querySelectorAll('th, td').forEach(cell => {
                cell.style.backgroundColor = 'transparent';
                cell.style.color = '#000';
            });
            
            printWindow.document.write(originalTable.outerHTML);

            // 6. Add Unexpected Items List
            const unexpectedItemsArray = Array.from(unexpectedScans.values());

            printWindow.document.write('<h2 style="font-size: 16pt; margin-top: 30px; margin-bottom: 10px; font-weight: bold;">2. Unexpected Scans / Unlisted Items</h2>');

            if (unexpectedItemsArray.length > 0) {
                let unexpectedTableHTML = `
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Unexpected ID</th>
                                <th>Scanned Count</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                unexpectedItemsArray.forEach(item => {
                    unexpectedTableHTML += `
                        <tr>
                            <td>${item.rawId}</td>
                            <td>${item.count}</td>
                        </tr>
                    `;
                });
                unexpectedTableHTML += '</tbody></table>';
                printWindow.document.write(unexpectedTableHTML);
            } else {
                printWindow.document.write('<p>No unexpected (unlisted) items were scanned.</p>');
            }

            // 7. Close and Print
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            // Wait for content to render before printing
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };

            // Fallback in case onload doesn't fire immediately
            setTimeout(() => {
                 try {
                     if (printWindow && !printWindow.closed) {
                         printWindow.focus();
                         printWindow.print();
                         printWindow.close();
                     }
                 } catch(e) { /* Ignore error if window already closed */ }
            }, 500);
        }

        // --- EXPORT FUNCTIONS (UNMODIFIED) ---

        /**
         * Exports the full list (expected + unexpected) to a CSV file.
         */
        function exportFullList() {
            let csv = '';
            
            // 1. Expected Items Headers
            const expectedHeaders = [...detectedHeaders, 'Expected Quantity', 'Scanned Count', 'Remaining'];
            if (expectedStock.some(item => item.unitPrice > 0)) {
                expectedHeaders.push('Unit Price');
            }
            csv += '--- EXPECTED INVENTORY ---\n';
            csv += expectedHeaders.join(',') + '\n';

            // 2. Expected Items Data
            expectedStock.forEach(item => {
                const values = expectedHeaders.map(header => {
                    if (header === 'Expected Quantity') return item.expectedQuantity;
                    if (header === 'Scanned Count') return item.scannedCount;
                    if (header === 'Remaining') return item.expectedQuantity - item.scannedCount;
                    if (header === 'Unit Price') return formatValue(item.unitPrice, true);

                    const value = item[header] || '';
                    return `"${String(value).replace(/"/g, '""')}"`; // Handle commas and quotes in data
                });
                csv += values.join(',') + '\n';
            });

            // 3. Unexpected Items Headers & Data
            csv += '\n--- UNEXPECTED SCANS ---\n';
            csv += 'Unexpected ID,Scanned Count\n';

            Array.from(unexpectedScans.values()).forEach(item => {
                 csv += `"${String(item.rawId).replace(/"/g, '""')}",${item.count}\n`;
            });
            
            downloadCSV(csv, 'full_inventory_report.csv');
        }

        /**
         * Exports only the unexpected items list to a CSV file.
         */
        function exportUnexpectedItems() {
             let csv = 'Unexpected ID,Scanned Count\n';

            Array.from(unexpectedScans.values()).forEach(item => {
                 csv += `"${String(item.rawId).replace(/"/g, '""')}",${item.count}\n`;
            });
            
            downloadCSV(csv, 'unexpected_items_report.csv');
        }

        /**
         * Exports the full state as a JSON file.
         */
        function exportFullListJSON() {
            const data = {
                metadata: {
                    loadedHeaders: detectedHeaders,
                    uniqueIdHeader: uniqueIdHeaderNameInput.value.trim(),
                    quantityHeader: quantityHeaderNameInput.value.trim(),
                    priceHeader: priceHeaderNameInput.value.trim(),
                    currencySymbol: detectedCurrencySymbol,
                    checkedBy: colleagueNameInput.value.trim(),
                    exportDate: new Date().toISOString()
                },
                expectedStock: expectedStock,
                unexpectedScans: Array.from(unexpectedScans.values())
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'full_inventory_report.json', 'application/json');
        }


        /**
         * Helper function to trigger a file download.
         */
        function downloadCSV(csv, filename) {
             const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
             downloadFile(blob, filename, 'text/csv');
        }
        
        function downloadFile(content, filename, mimeType) {
            const element = document.createElement('a');
            element.setAttribute('href', `data:${mimeType};charset=utf-8,${encodeURIComponent(typeof content === 'string' ? content : content.toString())}`);
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }


        // --- UI UTILITIES ---

        /**
         * Clears any previous message and shows a new status message in the scanner box.
         */
        let statusTimeout;
        function showMessage(message, colorClass = 'text-gray-500') {
            clearTimeout(statusTimeout);
            statusMessage.textContent = message;
            statusMessage.className = `mt-3 text-sm font-medium h-5 ${colorClass}`;
            statusTimeout = setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = 'mt-3 text-sm font-medium h-5';
            }, 3000);
        }

        /**
         * Clears any previous message and shows a new status message in the load data box.
         */
        window.loadStatusTimeout; // Made global for access within loadStockData
        function showLoadMessage(message, colorClass = 'text-gray-500') {
            clearTimeout(window.loadStatusTimeout);
            loadStatusMessage.textContent = message;
            loadStatusMessage.className = `mt-3 text-sm font-medium h-5 ${colorClass}`;
            window.loadStatusTimeout = setTimeout(() => {
                loadStatusMessage.textContent = '';
                loadStatusMessage.className = 'mt-3 text-sm font-medium h-5';
            }, 5000);
        }


        /**
         * Filters the main stock table based on user input.
         */
        function filterTable() {
            const filterText = filterInput.value.trim().toUpperCase();
            const rows = stockTableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const searchData = row.dataset.search || '';
                if (searchData.includes(filterText)) {
                    row.style.display = ''; 
                } else {
                    row.style.display = 'none';
                }
            });
        }


        /**
         * Updates the Demo Mode badge visibility.
         */
        function updateDemoBadge() {
            if (isDemoData) {
                demoModeBadge.classList.remove('hidden');
            } else {
                demoModeBadge.classList.add('hidden');
            }
        }

        /**
         * Loads the initial demo data structure.
         */
        function initializeWithInitialData() {
            // Manually set headers for demo data
            uniqueIdHeaderNameInput.value = 'Asset ID';
            quantityHeaderNameInput.value = 'Expected Quantity';
            priceHeaderNameInput.value = 'Unit Price';
            
            expectedStock = initialStockData;
            detectedHeaders = initialHeaders;
            isDemoData = true;

            stockMap.clear();
            expectedStock.forEach((item, index) => {
                stockMap.set(item.id, index);
            });
            unexpectedScans.clear();
            
            // Manually detect currency symbol from first item
            if (initialStockData.length > 0) {
                 detectedCurrencySymbol = getCurrencySymbol(initialStockData[0]['Unit Price']);
            }

            renderTable();
            // Do not clear the text area as no data was loaded from it
        }

        // --- SESSION MANAGEMENT (LOCAL STORAGE) ---

        /**
         * Saves the current state of the app to localStorage.
         */
        function saveState() {
            const state = {
                expectedStock: expectedStock,
                unexpectedScans: Array.from(unexpectedScans.entries()), // Maps need conversion
                detectedHeaders: detectedHeaders,
                lastScannedId: lastScannedId,
                uniqueIdHeaderName: uniqueIdHeaderNameInput.value,
                quantityHeaderName: quantityHeaderNameInput.value,
                priceHeaderName: priceHeaderNameInput.value,
                colleagueName: colleagueNameInput.value,
                detectedCurrencySymbol: detectedCurrencySymbol,
                isDemoData: isDemoData
            };
            try {
                localStorage.setItem('stockCheckState', JSON.stringify(state));
            } catch (e) {
                console.error("Could not save state to local storage:", e);
            }
        }

        /**
         * Loads the previous state from localStorage.
         */
        function loadState() {
            try {
                const savedState = localStorage.getItem('stockCheckState');
                if (savedState) {
                    const state = JSON.parse(savedState);

                    expectedStock = state.expectedStock || [];
                    unexpectedScans = new Map(state.unexpectedScans || []);
                    detectedHeaders = state.detectedHeaders || [];
                    lastScannedId = state.lastScannedId || 'N/A';
                    detectedCurrencySymbol = state.detectedCurrencySymbol || '';
                    isDemoData = state.isDemoData || false;

                    // Restore input fields
                    uniqueIdHeaderNameInput.value = state.uniqueIdHeaderName || '';
                    quantityHeaderNameInput.value = state.quantityHeaderName || '';
                    priceHeaderNameInput.value = state.priceHeaderName || '';
                    colleagueNameInput.value = state.colleagueName || '';

                    // Rebuild stockMap
                    stockMap.clear();
                    expectedStock.forEach((item, index) => {
                        stockMap.set(item.id, index);
                    });
                    
                    lastScannedDisplay.textContent = lastScannedId;

                    renderTable();
                    updateDemoBadge(); // Restore badge display
                    if (expectedStock.length > 0) {
                        showMessage('Session resumed successfully.', 'text-gray-500');
                    } else if(isDemoData) {
                         // Fallback for an empty but set demo state
                         initializeWithInitialData();
                         showMessage('Demo session resumed successfully.', 'text-yellow-700');
                    }
                    return;
                }
            } catch (e) {
                console.error("Error loading state from local storage:", e);
                // Clear corrupted state and proceed to load initial
                localStorage.removeItem('stockCheckState');
            }
            
            // If no state or error, load initial demo data
            initializeWithInitialData();
            updateDemoBadge();
            saveState();
        }

        /**
         * Resets the entire application state and clears local storage.
         */
        function resetAppAndClearStorage() {
             if (!confirm("WARNING: This will clear ALL data, including your stock list, all scans, and all settings from your browser's memory. Are you sure you want to perform a FULL reset?")) {
                return;
            }
            
            // Clear current data
            expectedStock = [];
            detectedHeaders = [];
            stockMap.clear();
            unexpectedScans.clear();
            lastScannedId = 'N/A';
            detectedCurrencySymbol = '';
            
            // Clear input fields
            stockDataTextarea.value = '';
            uniqueIdHeaderNameInput.value = '';
            quantityHeaderNameInput.value = '';
            priceHeaderNameInput.value = '';
            colleagueNameInput.value = '';

            // Clear storage
            try {
                localStorage.removeItem('stockCheckState');
            } catch (e) {
                console.error("Could not clear local storage:", e);
            }

            // Reload default demo data and update UI
            initializeWithInitialData();
            updateDemoBadge();
            renderTable();
            saveState(); // Save the new, clean demo state
            showLoadMessage('‚úÖ Full application reset complete. Demo data loaded.', 'text-green-600');
            scannerInput.focus();
        }


        // --- INITIALIZATION ---
        window.onload = function() {
            loadState(); 
            
            scannerInput.addEventListener('keydown', handleScan);
            loadDataButton.addEventListener('click', loadStockData);
            
            // New event listener for auto-detection on paste/input
            stockDataTextarea.addEventListener('input', handleDataPaste);
            
            completeCheckButton.addEventListener('click', completeCheck);
            clearAllButton.addEventListener('click', clearAllScans);
            
            filterInput.addEventListener('keyup', filterTable); 

            // Listener for Sign-off Input to save state on every change
            colleagueNameInput.addEventListener('input', () => {
                saveState();
            });

            // NEW: Full Reset Button Listener
            document.getElementById('resetAppButton').addEventListener('click', resetAppAndClearStorage);
            
            scannerInput.focus(); 
        };

    </script>
</body>
</html>
